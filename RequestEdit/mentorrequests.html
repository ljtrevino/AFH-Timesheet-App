<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  <title>Mentor Edit</title>
  <script
  src="https://code.jquery.com/jquery-2.1.0.min.js"
  integrity="sha256-8oQ1OnzE2X9v4gpRVRMb1DWHoPHJilbur1LP9ykQ9H0="
  crossorigin="anonymous"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  
  <link rel='stylesheet prefetch' href='https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/a549aa8780dbda16f6cff545aeabc3d71073911e/build/css/bootstrap-datetimepicker.css'>

  <link rel="stylesheet" href="../style.css">
  
</head>

<body>
<a href="../mentorapproval.html"><img src="../back-arrow-red.png" style="transform: scale(.6)"/></a>
<!--Add buttons to initiate auth sequence and sign out-->
<button id="authorize-button" class="grey" style="float: right; margin: 10px; color: white; padding-top: .8rem;" >Admin Authorize</button>
<button id="signout-button" class="grey" style="float: right; margin: 10px; color: white; padding-top: .8rem;" >Admin Sign Out</button>


    <div class="container" style="margin-top: 15vh">

        <div class="row">
            <div class="col-12 text-center" style="height:4em"></div>

            <div id = "title" class="col-12 text-center" style="font-size: 4em;">
              REQUEST EDIT
            </div>
            <div class="col-12 text-center" style="height:4em"></div>
        </div>
        
        <div class="row">
            <div class="col-12 text-center" style="height:4em"></div>

            <div class="col-12 text-center" style="font-size: 1em;">
              Edit timesheets directly by selecting the day the teen worked extra hours
              or the day their time was recorded incorrectly as well as the correct start and end time.
              You can directly add these hours into the teen's "extra hours" column for this week, 
              which should be done if the edited hours are from a previous work week. *IMPORTANT:
              The override option writes over the current hours in the teen's timesheet for that day of the week. 
              You should only use this option if you are editing a start/end time from this week.
            </div>
            <div class="col-12 text-center" style="height:4em"></div>
        </div>


        <div class="form-group row">
          <label for="colFormLabelLg" class="col-sm-3 col-form-label col-form-label-lg" style="font-size: 1.32em;">Date of Edit/Extra Work</label>
            <div class="col-sm-9">
              <div class="form-group">
                    <div class="input-group date form-input" id="datetimepicker1">
                        <input id = "day" type="text" class="form-control" />  <span class="input-group-addon"><span class="glyphicon-calendar glyphicon"></span></span>
                    </div>
                </div>
            </div>
        </div>
  
        <div class="form-group row">
          <label for="colFormLabelLg" class="col-sm-3 col-form-label col-form-label-lg" style="font-size: 1.32em;">Start Time</label>
            <div class="col-sm-9">
              <div class="form-group">
                    <div class="input-group date form-input" id="datetimepicker2">
                        <input id = "start" type="text" class="form-control" />  <span class="input-group-addon"><span class="glyphicon-time glyphicon"></span></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-group row">
          <label for="colFormLabelLg" class="col-sm-3 col-form-label col-form-label-lg" style="font-size: 1.32em;">End Time</label>
            <div class="col-sm-9">
              <div class="form-group">
                    <div class="input-group date form-input" id="datetimepicker3">
                        <input id = "end" type="text" class="form-control" />  <span class="input-group-addon"><span class="glyphicon-time glyphicon"></span></span>
                    </div>
                </div>
            </div>
        </div>
  
</div>

<div class="row" style="height: 3rem;"></div>
         
        <div class="row" style="height: 3rem;">
          <a onclick = "addAsExtra()" type="button" role="button" class="btn btn-lg btn-block red" style="width: 50%; margin-left: 25%; color:white; padding-top: 1.4em;">MAKE CHANGE AND ADD AS EXTRA HOURS</a>
</div>
<div class="row" style="height: 3rem;"></div>
<div class="row" style="height: 3rem;">
          <a onclick = "override()" type="button" role="button" class="btn btn-lg btn-block red" style="width: 50%; margin-left: 25%; color:white; padding-top: 1.4em;">MAKE CHANGE AND OVERRIDE HOURS</a>
</div>
    
<script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/js/bootstrap.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.js'></script>
<script src='https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/a549aa8780dbda16f6cff545aeabc3d71073911e/src/js/bootstrap-datetimepicker.js'></script>

    <script  src="js/index.js"></script>
    <script type="text/javascript">
            $(function () {
                $('#datetimepicker1').datetimepicker({
                 format: 'MM/DD/YYYY'
                });
            });
        
            $(function () {
                $('#datetimepicker2').datetimepicker({
                    format: 'LT'
                });
            });
        
            $(function () {
                $('#datetimepicker3').datetimepicker({
                    format: 'LT'
                });
            });
    
      
     </script>
     <script type = "text/javascript"> 
      // Client ID and API key from the Developer Console
      var CLIENT_ID = '607362006296-la054vb71t7p8ju0ic4rc08ge4lc7j92.apps.googleusercontent.com';
      var API_KEY = 'AIzaSyAStm_2OiPlEUk0eJIg_UY8mShw6Fn9Fg8';

      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = "https://www.googleapis.com/auth/spreadsheets";

      var authorizeButton = document.getElementById('authorize-button');
      var signoutButton = document.getElementById('signout-button');
      
      // Names of participants and name of the studio they are in
      var studentRow;
      var studio;
      
      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
        });
      }

      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'block';
          studentRow = sessionStorage.getItem("studentRowNum");
          studio = sessionStorage.getItem("studioName");
          setTitle();
        } else {
          authorizeButton.style.display = 'block';
          signoutButton.style.display = 'none';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }
      
      function setTitle() {
      	gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '1K2cX-vwlYq-xOMtuHR98ou464pKTr3Lk4-b16YFP-Rw',
          range: studio+'!A'+studentRow.toString()+':AA',
        }).then(function(response) {
        	var range = response.result;
        	var row = range.values[0];
        	document.getElementById("title").innerHTML = "Editing hours for: " + row[0]+" " + row[1];
        	
        }, function(response) {
          appendPre('Error: ' + response.result.error.message);
        }); 
      }
	
	var currentExtraHours;
	function addAsExtra(){
        var day = document.getElementById('day').value;
        var start = document.getElementById('start').value;
        var end = document.getElementById('end').value;
        
        if (day == '' || start == '' || end == '') {
        	alert('Please fill in all fields.');
        } else {
        	var startAsDate =  setDateTime(start); 
        	var endAsDate = setDateTime(end);
        	var hoursWorked = (endAsDate - startAsDate)/360000000
        	var minutes = hoursWorked % 1
        	var minutesRounded = .25*Math.round(minutes*400)
        	var roundedHours = Math.round(hoursWorked) + minutesRounded;
        	        	
        	gapi.client.sheets.spreadsheets.values.get({
			  spreadsheetId: '1K2cX-vwlYq-xOMtuHR98ou464pKTr3Lk4-b16YFP-Rw',
			  range: studio+'!U'+studentRow,
			}).then(function(response) {
				var range = response.result;
				if (typeof range.values != 'undefined') {
					var row = range.values[0];
					sessionStorage.setItem("currentExtraHours", row[0]); }
				else {
					sessionStorage.setItem("currentExtraHours", 0); }
					sessionStorage.setItem("updatedExtraHours", sessionStorage.getItem("currentExtraHours")/1.0 + roundedHours)
				gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: '1K2cX-vwlYq-xOMtuHR98ou464pKTr3Lk4-b16YFP-Rw',
                    range: studio + "!" + "U" + studentRow,
                    valueInputOption: 'USER_ENTERED',
                    values: [[sessionStorage.getItem("updatedExtraHours")]]
                }).then(function(response) {
                    console.log(response);
                }); 
			}, function(response) {
			  alert('Error: ' + response.result.error.message);
			}); 
      	}	
	}
	
	function override(){
      	var dayToNum = {'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 'Friday': 5, 'Saturday': 6, 'Sunday': 6}
        var nToCol = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        var day = document.getElementById('day').value;
        var start = document.getElementById('start').value;
        var end = document.getElementById('end').value;
        
        if (day == '' || start == '' || end == '') {
        	alert('Please fill in all fields.');
        } else {
        	var dayOfWeek = getDayOfWeek(day);
        	var colToChange = 3*(dayToNum[dayOfWeek]-1)+2
        	var startColToChange = nToCol.charAt(colToChange);
        	var endColToChange = nToCol.charAt(colToChange+1)
        	start = (timeConvertor(start)).slice(0, -2);
        	end = (timeConvertor(end)).slice(0, -2);
      		gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: '1K2cX-vwlYq-xOMtuHR98ou464pKTr3Lk4-b16YFP-Rw',
                    range: studio + "!" + startColToChange + studentRow + ":" + endColToChange + studentRow,
                    valueInputOption: 'USER_ENTERED',
                    values: [[start, end]]
                }).then(function(response) {
                    console.log(response);
                });
      	}	
	}
	
	// Accepts a Date object or date string that is recognized by the Date.parse() method
	function getDayOfWeek(date) {
  		var dayOfWeek = new Date(date).getDay();    
  		return isNaN(dayOfWeek) ? null : ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek];
	}
	
	function setDateTime(time) {
		var index = time.indexOf(":"); // replace with ":" for differently displayed time.
		var index2 = time.indexOf(" ");

		var hours = time.substring(0, index);
		var minutes = time.substring(index + 1, index2);

		var mer = time.substring(index2 + 1, time.length);
		if (mer == "PM"){
			hours = hours + 12;
		}
		var date = new Date()
		date.setHours(hours);
		date.setMinutes(minutes);
		date.setSeconds("00");

		return date;
	}
	
	function timeConvertor(time) {
    	var PM = time.match('PM') ? true : false
    
    	time = time.split(':')
    	var min = time[1]
    
		if (PM) {
			var hour = 12 + parseInt(time[0],10);
		} else {
			var hour = time[0]; 
		}
    	var x = hour + ':' + min;
    	return x;
	}      
    </script>
    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
</body>

</html>

